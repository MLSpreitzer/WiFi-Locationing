## The FOLLOWING IS A WORK IN PROGRESS ## 

####################
## Load Packages ## 
####################
library(readr)
library(caret)
library(C50)
library(doParallel)
library(tidyr)
library(RMariaDB)
library(RMySQL)
library(ggplot2)

## Import data
RAWdata <- read.csv("trainingData.csv")


# Find how many cores are on your machine
detectCores() # Result = 4
# Create Cluster with desired number of cores. Don't use them all! Your computer is running other processes. 
cl <- makeCluster(2)
# Register Cluster
registerDoParallel(cl)
# Confirm how many cores are now "assigned" to R and RStudio
getDoParWorkers() # Result 2 
# Stop Cluster. After performing your tasks, stop your cluster. 
stopCluster(cl)


####################
## Pre-processing ## 
####################

# Verify data type
str(RAWdata) #19937 observations
str(RAWdata[,1:9])
summary(RAWdata[,1:9]) 

# Missing values? 
is.na(RAWdata) #false

# Basic histogram buildings
ggplot(RAWdata, aes(x=BUILDINGID)) + geom_histogram()

# Identify columns with no variance using nearZeroVar()  
nzvMetrics <- nearZeroVar(RAWdata, saveMetrics = TRUE)
nzvMetrics

# remove columns with no variance using nearZeroVar()  
RAWdata = subset(RAWdata, select = -c(WAP003,WAP004,WAP092,WAP093,WAP094,WAP095,WAP152,WAP158,WAP159,WAP160,WAP215,WAP217,WAP226,WAP227,WAP238,WAP239,WAP240,WAP241) )


#########################
## Feature Engineering ## 
#########################

# Group dataset by building number
FEdata.BLD1 <- FEdata[FEdata$BUILDINGID == 0, ]
FEdata.BLD2 <- FEdata[FEdata$BUILDINGID == 1, ]
FEdata.BLD3 <- FEdata[FEdata$BUILDINGID == 2, ]


## ----- option 1 ----- ##
## Loc_UID contains 735 levels

# Combine BUILDINGID, FLOOR, SPACEID 
FEdata <- unite(RAWdata, "Loc_UID", remove = TRUE, sep = ".", c("BUILDINGID","FLOOR", "SPACEID"))
Location1_Bld1 <- unite(FEdata.BLD1, "Loc_UID", remove = TRUE, sep = ".", c("BUILDINGID","FLOOR", "SPACEID"))
Location1_Bld2 <- unite(FEdata.BLD2, "Loc_UID", remove = TRUE, sep = ".", c("BUILDINGID","FLOOR", "SPACEID"))
Location1_Bld3 <- unite(FEdata.BLD3, "Loc_UID", remove = TRUE, sep = ".", c("BUILDINGID","FLOOR", "SPACEID"))

# Convert Loc_UID to factor 
FEdata$Loc_UID <- as.factor(FEdata$Loc_UID)
Location1_Bld1$Loc_UID <- as.factor(Location1_Bld1$Loc_UID)
Location1_Bld2$Loc_UID <- as.factor(Location1_Bld2$Loc_UID)
Location1_Bld3$Loc_UID <- as.factor(Location1_Bld3$Loc_UID)

# verify UID data type
str(FEdata[,1:9])


# Remove unneccasry columns
FEdata = subset(FEdata, select = -c(LONGITUDE,LATITUDE,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location1_Bld1 = subset(Location1_Bld1, select = -c(LONGITUDE,LATITUDE,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location1_Bld2 = subset(Location1_Bld2, select = -c(LONGITUDE,LATITUDE,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location1_Bld3 = subset(Location1_Bld3, select = -c(LONGITUDE,LATITUDE,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )


## ----- option 2  ----- ##
## Loc_UID2 contains 933 levels

# Combine LONGITUDE, LATITUDE, Floor 
FEdata2 <- unite(RAWdata, "Loc_UID2", remove = TRUE, sep = ".", c("LONGITUDE","LATITUDE", "FLOOR"))
Location2_Bld1 <- unite(FEdata.BLD1, "Loc_UID2", remove = TRUE, sep = ".", c("LONGITUDE","LATITUDE", "FLOOR"))
Location2_Bld2 <- unite(FEdata.BLD2, "Loc_UID2", remove = TRUE, sep = ".", c("LONGITUDE","LATITUDE", "FLOOR"))
Location2_Bld3 <- unite(FEdata.BLD3, "Loc_UID2", remove = TRUE, sep = ".", c("LONGITUDE","LATITUDE", "FLOOR"))

# Convert Loc_UID2 to factor 
FEdata2$Loc_UID2 <- as.factor(FEdata2$Loc_UID2)
Location2_Bld1$Loc_UID2 <- as.factor(Location2_Bld1$Loc_UID2)
Location2_Bld2$Loc_UID2 <- as.factor(Location2_Bld2$Loc_UID2)
Location2_Bld3$Loc_UID2 <- as.factor(Location2_Bld3$Loc_UID2)

# verify data type
str(FEdata2[,1:9])

# Remove unneccasry columns
FEdata2 = subset(FEdata2, select = -c(BUILDINGID,SPACEID,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location2_Bld1 = subset(Location2_Bld1, select = -c(BUILDINGID,SPACEID,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location2_Bld2 = subset(Location2_Bld2, select = -c(BUILDINGID,SPACEID,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )
Location2_Bld3 = subset(Location2_Bld3, select = -c(BUILDINGID,SPACEID,RELATIVEPOSITION,USERID,PHONEID,TIMESTAMP) )


## option 2 [Loc_UID2] has more levels (more precision) and we will use it instead of option 1. 

###############
## Modeling ## 
###############

# TTS 1 Y Value = Loc_UID2
set.seed(123)
trainSize<-round(nrow(FEdata2)*0.7) 
testSize<-nrow(FEdata2)-trainSize
trainSize # 13956
testSize # 5981
training_indices<-sample(seq_len(nrow(FEdata2)),size =trainSize)
trainSet<-FEdata2[training_indices,]
testSet<-FEdata2[-training_indices,] 

#10 fold cross validation
fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 1)

#train Random Forest Regression model with a tuneLenght = 1 (trains with 1 mtry value for RandomForest)
system.time(rfFitBuild <- train(Loc_UID2~., data = trainSet, method = "rf", trControl=fitControl, tuneLength = 1))
# Run time 2.7 hours

#training results
rfFitBuild


# %%%%%%%%%%%%  Predict Model 1 RF %%%%%%%%%%%% 

rfPred <- predict(rfFitBuild, newdata = testSet)
#To see the initial row of the predicited data
head(rfPred)
summary(rfFitBuild)

#To determine how the model prioritized each feature
varImp(rfFitBuild) # most important -- [WAP501]

rfClasses_i <- predict(rfFitBuild, newdata = testSet)
str(rfClasses_i)

postResample(rfPred, testSet$Loc_UID2)
# Accuracy     Kappa 
# 0.7965223   0.7962457
summary(rfPred)
plot(rfPred)

###############
## Modeling ## 
###############

# TTS 2 Y Value = Loc_UID2
set.seed(123)
trainSize<-round(nrow(FEdata2)*0.7) 
testSize<-nrow(FEdata2)-trainSize
trainSize # 13956
testSize # 5981
training_indices<-sample(seq_len(nrow(FEdata2)),size =trainSize)
trainSet<-FEdata2[training_indices,]
testSet<-FEdata2[-training_indices,] 

#10 fold cross validation
fitControl <- trainControl(method = "repeatedcv", number = 10, repeats = 1)

#train Random Forest Regression model with a tuneLenght = 1 (trains with 1 mtry value for RandomForest)
system.time(rfFitBuild <- train(Loc_UID2~., data = trainSet, method = "rf", trControl=fitControl, tuneLength = 1))
# Run time 

#training results
rfFitBuild


# %%%%%%%%%%%%  Predict Model 2 RF %%%%%%%%%%%% 

rfPred <- predict(rfFitBuild, newdata = testSet)
#To see the initial row of the predicited data
head(rfPred)
summary(rfFitBuild)

#To determine how the model prioritized each feature
varImp(rfFitBuild) # most important -- [WAP501]

rfClasses_i <- predict(rfFitBuild, newdata = testSet)
str(rfClasses_i)

postResample(rfPred, testSet$Loc_UID2)
# Accuracy     Kappa 

summary(rfPred)
plot(rfPred)


